<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>Mac 輕量極速版眼球畫布</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #111;
            display: flex; height: 100vh;
            font-family: "微軟正黑體", sans-serif;
        }

        /* --- 左側顏色選單 --- */
        #sidebar {
            /* 固定寬度，方便數學計算 */
            width: 200px; 
            background: #222;
            display: flex; flex-direction: column;
            padding: 5px; box-sizing: border-box;
            z-index: 20;
            border-right: 2px solid #444;
        }

        .color-btn {
            flex: 1; /* 平均分配高度 */
            margin-bottom: 5px;
            border-radius: 8px;
            border: 4px solid #333; 
            transition: transform 0.1s; /* 減少特效運算 */
            opacity: 0.6;
        }

        .color-btn.active {
            border-color: white; 
            transform: scale(1.02);
            opacity: 1;
            z-index: 10;
        }

        /* --- 右側畫布區 --- */
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; position: absolute; top: 0; left: 0; }

        /* --- 眼動紅點 --- */
        #gaze-dot {
            position: fixed; width: 30px; height: 30px;
            background: rgba(255, 0, 0, 0.5); 
            border-radius: 50%;
            border: 2px solid white;
            z-index: 9999; pointer-events: none;
            transform: translate(-50%, -50%);
        }

        /* --- 介面元件 --- */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        
        #reset-btn {
            position: absolute; bottom: 20px; right: 20px;
            padding: 15px 40px; font-size: 24px;
            background: #333; color: white;
            border: 3px solid #555; border-radius: 50px;
            z-index: 50; display: none; cursor: pointer;
        }

        #webgazerVideoContainer {
            top: 10px !important; right: 10px !important; left: auto !important;
            width: 160px !important; height: auto !important;
            opacity: 0.8; border: 2px solid white; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="gaze-dot"></div>

    <div id="start-overlay">
        <h1 style="font-size: 40px;">Mac 輕量版 (高效能)</h1>
        <p style="font-size: 24px; color: #aaa;">滑鼠點擊四角校正 -> 即看即畫</p>
        <button onclick="startGame()" style="padding: 15px 40px; font-size: 24px; margin-top: 30px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 10px;">點擊開始</button>
    </div>

    <div id="sidebar"></div>

    <div id="canvas-container">
        <canvas id="paint-canvas"></canvas>
        <button id="reset-btn">清除重畫</button>
    </div>

    <script>
        const canvas = document.getElementById('paint-canvas');
        const ctx = canvas.getContext('2d');
        const sidebar = document.getElementById('sidebar');
        const startOverlay = document.getElementById('start-overlay');
        const resetBtn = document.getElementById('reset-btn');
        const gazeDot = document.getElementById('gaze-dot');
        
        const palette = [
            { name: '火紅', color: '#FF0000', shadow: '#FF4500' },
            { name: '亮橘', color: '#FF8C00', shadow: '#FFA500' },
            { name: '金黃', color: '#FFD700', shadow: '#FFFF00' },
            { name: '螢光綠', color: '#00FF00', shadow: '#ADFF2F' },
            { name: '青空藍', color: '#00BFFF', shadow: '#00FFFF' },
            { name: '深海藍', color: '#0000FF', shadow: '#4169E1' },
            { name: '魔幻紫', color: '#8A2BE2', shadow: '#FF00FF' },
            { name: '彩虹', color: 'rainbow', shadow: 'white' }
        ];

        let currentColor = palette[0];
        let activeIndex = 0; // 記錄當前選中的是第幾個按鈕
        let lastX = null;
        let lastY = null;
        let lastToneTime = 0; // 音效冷卻
        
        // 選單寬度設定 (必須與 CSS #sidebar width 一致)
        const MENU_WIDTH = 200; 

        // --- 初始化 UI ---
        function initUI() {
            palette.forEach((item, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                // 不需要 ID 了，我們用數學算
                
                if (item.color === 'rainbow') {
                    btn.style.background = 'linear-gradient(180deg, red, orange, yellow, green, blue, indigo, violet)';
                } else {
                    btn.style.background = item.color;
                }
                
                if (index === 0) btn.classList.add('active');
                sidebar.appendChild(btn);
            });
            resizeCanvas();
        }

        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // --- 音效 (Mac Safari 優化) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq) {
            // 音效節流：避免聲音太密集導致卡頓
            const now = Date.now();
            if (now - lastToneTime < 150) return; 
            lastToneTime = now;

            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'triangle'; // 三角波比較省資源且好聽
            
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- 繪圖邏輯 ---
        function draw(x, y) {
            const rect = canvas.getBoundingClientRect();
            const cx = x - rect.left;
            const cy = y - rect.top;

            if (lastX !== null && (Math.abs(cx - lastX) > 200 || Math.abs(cy - lastY) > 200)) {
                lastX = cx; lastY = cy; return;
            }

            if (lastX !== null) {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(cx, cy);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 15 + Math.random() * 25; // 稍微細一點，減輕負擔

                if (currentColor.color === 'rainbow') {
                    const hue = Math.floor(Math.random() * 360);
                    ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
                } else {
                    ctx.strokeStyle = currentColor.color;
                }
                
                // 移除陰影運算 (shadowBlur)，這是造成 Mac 卡頓的主因之一
                // ctx.shadowBlur = 10; 
                
                ctx.stroke();
            }
            lastX = cx; lastY = cy;
        }

        // --- 更新選單 UI (手動切換 class) ---
        function updateMenuUI(newIndex) {
            if (newIndex === activeIndex) return; // 沒變就不動，省資源
            
            const btns = document.querySelectorAll('.color-btn');
            btns[activeIndex].classList.remove('active');
            btns[newIndex].classList.add('active');
            
            activeIndex = newIndex;
            currentColor = palette[newIndex];
            playTone(800); // 換色提示音
        }

        function startGame() {
            startOverlay.style.display = 'none';
            resetBtn.style.display = 'block';
            initUI();

            webgazer.setRegression('ridge')
                .setGazeListener(function(data, clock) {
                    if (data == null) return;

                    // 1. 移動紅點
                    gazeDot.style.left = data.x + 'px';
                    gazeDot.style.top = data.y + 'px';

                    // 2. 超高速邏輯判斷 (取代 elementFromPoint)
                    // 直接判斷 X 座標是否在左側 200px 內
                    if (data.x < MENU_WIDTH) {
                        
                        // --- 進入選單區 ---
                        lastX = null; // 停止繪畫
                        
                        // 計算現在看著第幾個按鈕 (Y座標 / 按鈕高度)
                        const btnHeight = window.innerHeight / 8; // 因為有 8 個按鈕
                        let targetIndex = Math.floor(data.y / btnHeight);
                        
                        // 防止邊界錯誤 (看太上面或太下面)
                        if (targetIndex < 0) targetIndex = 0;
                        if (targetIndex > 7) targetIndex = 7;
                        
                        // 更新 UI
                        updateMenuUI(targetIndex);

                    } else {
                        // --- 進入畫布區 ---
                        draw(data.x, data.y);
                    }
                })
                .begin();

            webgazer.showVideoPreview(true);
        }

        resetBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            lastX = null;
        });
        
        window.addEventListener('resize', () => {
            resizeCanvas();
        });

    </script>
</body>
</html>
